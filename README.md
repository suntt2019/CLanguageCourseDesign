# CLanguageCourseDesign C语言课程设计

## TODO LIST
(暂时置顶，等游戏基本上完成后放到后面)

### 最后收尾
* 音效随连击次数改变声高
* 菜单部分增加背景音乐
* 显示分数
* 显示开发者页面

### DEBUG
* 单色图中，打掉一条之后，另一条会吸走祖玛口中的球（如果此时那个球与另一条球列接触）
* 快速插入时，会出现一长串处于插入中的球，此时如果发生消除断链，后面的球可能与前面的球重合而不推动前面的球（bug复现不稳定，可以尝试调小射球CD）

### 核心游戏部分
* 路径
  * 路径点生成器
  * (optional) 公式方式存储路径（加载地图时转化为点）
* 球列
  * (optional) 碰撞消除粒子效果
  * (optional) 特殊球
  * 后球追上前球触发判定？（参考zuma原作）
* 祖玛
  * （optional) zuma口中球变色动画
  * （optional) 射球CD动画
* 图像
  * （optional) 增加前景功能（保证性能足够的前提下）
* 音频
  * 增加音频
* 分数
  * 分数系统
    * （optional) 飞出球球穿过球列消除加分
  * 状态栏
* （optional) 金币



### 外围
* 外围界面
  * 主界面（标题界面）
  * 选择地图界面
  * 暂停界面（ESC界面）
    * 焦点脱离游戏窗口自动暂停
  * 选项界面
    * （optional) 界面缩放功能
    * 音频音量
* 关卡设计
  * 更小的球与更长的路

### 程序设计
* 拆分长的函数，整理函数
* free & delete
* warnings
* magic number
 
 <br><br>


## 游戏整体构想
仿制宝开(PopCap)2004年开放的小游戏[《祖玛》](https://baike.baidu.com/item/%E7%A5%96%E7%8E%9B/132172)。
 

### 游戏规则
  * 主要规则
    * 游戏开始时，轨道上出现一串颜色随机生成的球列，球列会不断前进，其抵达轨道终点时游戏失败

    * 玩家可以用鼠标控制祖玛射球方向，通过点击将祖玛口中的球射出，插入不断向前移动的球列中

    * 由于插入球导致的，`三个及以上连续的同色球` 会相消，并使玩家得分，连续同色球越多增加分数越多

    * 所有球都被消除时，玩家取得胜利

  * 补充说明
    * 玩家可以看到 祖玛口中的球 和 下一个进入祖玛口中的球 的颜色。

    * 玩家获胜时，额外获得点数等于 `球列消失点到终点距离` 的分数。  



### 功能设计
  * 核心游戏部分
    * 祖玛
      * 显示接下来要发射两球的颜色
      * 鼠标移动时：转动，发射方向始终指向鼠标
      * 鼠标点击时：生成 `飞出球` ，随机产生新球颜色，新球替旧球
    * 球列
      * 持续按轨道前进
      * 随机生成（给定球数）
      * 有球插入时：链表插入，检查消除
      * 检测消除时：检查有无 `三个以上同色球` 相连，若有则链表删除，增加分数，再次检测消除
    * 飞出球
      * 持续直线移动
      * 持续监测与球列各球距离，`d<=2R` 则插入球列

  * 周边辅助功能
    * 菜单
      * 开始菜单：随机游戏、载入地图、选项、退出
      * 载入地图菜单：路径输入框、提示栏、确认键
      * 暂停菜单：返回游戏、选项、退出到主菜单
      * 选项菜单：分辨率、是否全屏、音量调整
    * 保存地图
      * 保存背景图片
      * 保存轨道路径

  * 可选拓展功能
    <br>
     \* 该部分功能为完成以上两部分功能后，若还有时间精力，丰富拓展游戏的可选功能
    * 路径编辑器
      * 基础版：可以手动调整参数，生成路径
      * 提升版：程序自动计算位置和一阶导，保证路径C1连续


### 程序设计思路-核心游戏部分
  * 数据结构
    * 球列
      * 首位置(int*1)：第一个球在轨道上的位置
      * 双向链表(int链表*1)：储存每个球颜色
    * 飞出球
      * 飞出球数组(`飞出球`数组*1)：存储所有飞出球数据
      * 结构体`飞出球`：包含球飞行方向与x轴夹角、球当前坐标、颜色
    * 轨道
      * 位置点(double数组*2)：用位置点的方式存储轨道路径
      * 轨道函数参数(int数组*1)：记录轨道函数的几个重要参数来实现不同的轨道函数

  * 流程设计(一个循环中)
    * 处理玩家操作
      * 读取鼠标事件直到清空
        * 鼠标移动：祖玛朝向鼠标
        * 鼠标点击：祖玛发射球
      * 键盘事件
        * `ESC键`：进入暂停菜单
        * `空格键`：祖玛发射球
    * 计算飞出球
      * 飞出球进行位移
      * 碰撞检测
    * 计算球列
      * 球列前移
      * 到终点->游戏失败
    * 绘制图像
      * 球列：根据轨道数据
      * 飞出球：根据`飞出球`结构体内坐标

  * 关键函数
    * 碰撞检测(飞出球)
      * 遍历球列，找到第一个满足`d<=2R`的列上球
      * 检测飞出球与该球相邻的两球相比，哪个更近
      * 将飞出球插入球列（传入飞出球的颜色）
    * 插入球列(颜色)
      * 链表中插入新的列上球
      * 检测消除（传入新的列上球）
    * 检测消除(列上球)
      * 检测该球作为前/中/后是否有能连成三个同色的
      * 若有连成同色的：
        * 得分增加
        * 链表中删除对应的列上球
        * 检测消除（传入消除部分相邻的列上球）*2

<br>

#### * 其余部分待实现过程中再确定，大部分细节不再赘述

[TODO]:其余部分的程序设计思路（可能不写）
[TODO]:操作指南


### 拓展功能

#### 去[4399上](http://www.4399.com/flash/194904_1.htm)玩了下祖玛，发现还有很多可以改进的地方

* 运动动画
  * 滚动动画
    * 时刻有滚动动画，球撞击引发的移动也有对应动画
    * 球的运动都是有时间长度的动画，而不是瞬移
  * 插入球的时候
    * 后面的不动，前面的被推向前一个球的距离
    * 滑入动画（不太确定是不是有）
  * 当球列中间发生碰撞时
    * 后半部分照常前进
    * 前部部分停止，直到后半部分跟进
    * 若可以连击，前半部分后退与后半部分撞击
    * 粒子效果+加分动画
* 球列
  * 更多的连续球：带来更爽快的游戏体验
  * 运动速度比当前慢很多，温水煮青蛙的感觉
* 特殊球
  * 特殊球增加趣味性（计划后期再加这个）
  * 目前看到的效果：瞄准/冰冻/后退/炸开/火球（祖玛吐出，毁灭撞到的球）
* 分数系统
  * 结束时的点到终点的距离算分（其实这个有在计划中）


<br>

#### 这里是后来专门去玩了宝开的原版（steam正版，免费试玩版）的感受
* 运动动画
  * 球并不会滚动
  * 开始的时候就会猛冲出来一段
  * 飞出球撞到球列上进入的时候有滑入的动画、包括列上球也随动
* 祖玛
  * 右键交换，点祖玛交换？？
  * 只会吐出现场还有的颜色的球（口中的“已不在场色”球会变色）
  * 射球、换球动画
* 球列
  * 穿过球列中间的洞有加分
* 终点
  * 会随着球列靠近不断张大，给人增加紧张情绪
* 特殊球
  * 有一个蓄能槽，能量满了之后随机将一个球变成特殊球
  * 一段时间不将特殊球消除，特殊球会变回普通球
  * 存在时慢闪，变化时快闪
  * 目前发现的特殊球：瞄准（计算遮挡关系）/减速/爆炸/倒退
  * （不确定是不是特殊球触发）加一条命
* 金币
  * 能拿到的话，会有比较多的加分
  * 刷的位置是固定而且有标记的
  * 似乎在金币旁边消球也能拿到金币？？
  * 一段时间不拿会消失
* 关卡设计
  * 初始球列中越到后面长连的越多，4-6连那种
  * 前几关越往后轨道越长（当然球也越多）
  * 轨道重叠放置效果很好，遮挡关系可以增加许多趣味性
  * （关底）两条球列会增加难度、紧张感和趣味性很多
  * 冒险模式有命数的设定，增大试错成本，加大难度和紧张感
  * 计时，给人再次挑战的理由和目标
  * 地下球（不同层间依然有遮挡关系，不过不能打到钻地部分）
  * 最开始冲的那一段长度很大程度影响关卡
* 配乐
  * BGM和音效都无比魔性，充满特色
  * 焦点脱离游戏的时候会暂停
* 辅助
  * 有一个操作指导的帮助菜单
  * 每次关卡结束报告有小提示
  * ESC界面看不见球，大概是防止暂停推算？也可能就是省事
  * 窗体失去焦点会显示PAUSED并暂停游戏
 
* 整体感受
  * 细节处理（动画、音效、美术）能加强许多代入感
  * 会带来一种持续的压力感，比较刺激（类似滑雪圈）
  * 比想象中的好玩，挺带劲，大餐有大餐的美味，小品也有小品的出色

* 社会影响
  * 感觉虽然不及《植物大战僵尸》，但知名度也算是很高了，一代经典的感觉
  * 看steam评论里，好多人说这是 “你永远打不过你妈的游戏” 、“奶奶最擅长的游戏” 、 “童年回忆” 等等。可见这游戏已经融入大家的生活，还是挺有感触的